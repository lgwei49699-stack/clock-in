name: æ¯æ—¥æµ‹è¯•æ‰“å¡æé†’
on:
  # 1. å®šæ—¶è§¦å‘ï¼šæ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ 10:00 (UTC 02:00)
  schedule:
    - cron: '0 2 * * *'
  # 2. æ‰‹åŠ¨è§¦å‘ï¼šæ–¹ä¾¿ä½ æµ‹è¯•å¥½ä¸å¥½ç”¨
  workflow_dispatch:

jobs:
  send-notification:
    runs-on: ubuntu-latest
    steps:
      - name: è®¡ç®—æµ‹è¯•å¤©æ•°
        id: calc
        run: |
          # === è¯·ä¿®æ”¹è¿™é‡Œï¼šæµ‹è¯•å¼€å§‹çš„æ—¥æœŸ (æ ¼å¼ YYYY-MM-DD) ===
          START_DATE="2025-12-05"
          # ===============================================
          
          CURRENT_DATE=$(date +%Y-%m-%d)
          start_ts=$(date -d "$START_DATE" +%s)
          current_ts=$(date -d "$CURRENT_DATE" +%s)
          
          # è®¡ç®—å¤©æ•°å·® (+1 æ˜¯å› ä¸ºç¬¬ä¸€å¤©ä¹Ÿç®—ä¸€å¤©)
          diff_days=$(( (current_ts - start_ts) / 86400 + 1 ))
          
          # è®¡ç®—å‰©ä½™å¤©æ•° (ç›®æ ‡ 14 å¤©)
          left_days=$(( 14 - diff_days ))
          if [ $left_days -lt 0 ]; then left_days=0; fi
          
          echo "days=$diff_days" >> $GITHUB_OUTPUT
          echo "left=$left_days" >> $GITHUB_OUTPUT

      - name: å‘é€é£ä¹¦æ¶ˆæ¯
        env:
          DAYS: ${{ steps.calc.outputs.days }}
          LEFT: ${{ steps.calc.outputs.left }}
        run: |
          # æ”¹ç”¨äº¤äº’å¡ç‰‡ + markdownï¼Œç¡®ä¿ç²—ä½“ç”Ÿæ•ˆï¼Œä¸”åŒ…å«å…³é”®è¯â€œæé†’â€
          cat <<EOF > payload.json
          {
            "msg_type": "interactive",
            "card": {
              "config": {
                "wide_screen_mode": true
              },
              "header": {
                "title": {
                  "tag": "plain_text",
                  "content": "ğŸš¨ Google Play æµ‹è¯•æ‰“å¡æé†’ ğŸš¨"
                }
              },
              "elements": [
                {
                  "tag": "markdown",
                  "content": "ä»Šå¤©æ˜¯æµ‹è¯•ç¬¬ **$DAYS** å¤©ï¼Œè·ç¦»èƒœåˆ©è¿˜æœ‰ **$LEFT** å¤©ï¼"
                },
                {
                  "tag": "markdown",
                  "content": "è¯·å„ä½å¤§ä½¬åŠ¡å¿…ï¼š\n1. æ‰“å¼€ App\n2. è”ç½‘åœç•™ 2-3 åˆ†é’Ÿ\n3. éšä¾¿ç‚¹ä¸¤ä¸‹\n4. æ‰“å¼€é“¾æ¥ï¼Œå¡«å†™æ‰“å¡ç»“æœï¼š\nhttps://ver133tlfd.feishu.cn/wiki/BAzWwVQcriPnaskup7VchRkwnfc\n\næ„Ÿæ¿€ä¸å°½ï¼ ğŸ™"
                }
              ]
            }
          }
          EOF

          curl -X POST -H "Content-Type: application/json" \
            -d "@payload.json" \
            ${{ secrets.FEISHU_WEBHOOK }}

